name: Docs deploy
on:
  workflow_run:
    workflows: ["Docs build"]
    types:
      - completed

jobs:
  checks:
    runs-on: ubuntu-latest
    outputs:
      parameters: ${{ steps.parameters.outputs.result }}
    steps:
      - if: ${{ github.event.workflow_run.conclusion == 'failure' }}
        run: echo 'The triggering workflow failed' && exit 1
      
      - name: Determine deploy parameters
        id: parameters
        uses: actions/github-script@v7
        with:
          script: |
            const eventType = context.payload.workflow_run.event;
            const isFork = context.payload.workflow_run.repository.fork;

            if (eventType == "push") {
              const branch = context.payload.workflow_run.head_branch;
              const shouldDeploy = !isFork && branch == "main";
              return {
                event: "branch",
                name: "main",
                shouldDeploy
              };
            }

            if (eventType == "pull_request") {
              const pull_number = context.payload.workflow_run.pull_requests[0].number;
              const {data: pr} = github.rest.pulls.get({
                owner: "immich-app",
                repo: "immich",
                pull_number
              });
              const isApproved = pr.labels.some((l) => l.name == "preview-docs";
              const shouldDeploy = !isFork || isApproved;
              return {
                event: "pr",
                name: pull_number,
                shouldDeploy
              };
            }

            if (eventType == "release") {
              return {
                event: "release",
                name: context.payload.workflow_run.head_branch,
                shouldDeploy: !isFork
              };
            }

  deploy:
    runs-on: ubuntu-latest
    needs: checks
    if: ${{ needs.checks.outputs.parameters.shouldDeploy }}
    steps:
      - run: |
          echo Starting docs deployment for ${{ needs.checks.outputs.parameters.name }} (trigger: ${{ needs.checks.outputs.parameters.event }}
      # TODO: Download docs build artifact
      # TODO: Terraform shenanigans
      # TODO: Comment URL on PR
